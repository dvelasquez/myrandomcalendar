---
import { actions } from 'astro:actions';
import PublicLayout from '../layouts/PublicLayout.astro';
import { Button } from '@/components/ui/button';
import ButtonLink from '@/components/ui/button-link';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';

export const prerender = false; // Required for server actions

// Get action result for error handling
const result = Astro.getActionResult(actions.auth.register);
---

<PublicLayout title="Register - My Random Calendar">
  <Card>
      <CardHeader>
        <CardTitle className="text-2xl text-center">Create Account</CardTitle>
      </CardHeader>

      <CardContent>
        <!-- Display error message if registration failed -->
        {
          result?.error && (
            <div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
              {result.error.message}
            </div>
          )
        }

        <form method="POST" action={actions.auth.register} class="space-y-4">
          <div>
            <Label htmlFor="name" className="text-gray-700">Name</Label>
            <Input
              type="text"
              id="name"
              name="name"
              required
              className="mt-1"
            />
          </div>

          <div>
            <Label htmlFor="email" className="text-gray-700">Email</Label>
            <Input
              type="email"
              id="email"
              name="email"
              required
              className="mt-1"
            />
          </div>

          <div>
            <Label htmlFor="password" className="text-gray-700">Password</Label>
            <Input
              type="password"
              id="password"
              name="password"
              required
              className="mt-1"
            />
          </div>

          <Button type="submit" className="w-full"> Sign Up </Button>
        </form>

        <div class="mt-4 text-center">
          <p class="text-sm text-gray-600">
            Already have an account?
            <ButtonLink variant="link" href="/login">Sign in</ButtonLink>
          </p>
        </div>
      </CardContent>
    </Card>
</PublicLayout>

<script>
  import { actions } from 'astro:actions';
  import { navigate } from 'astro:transitions/client';

  const form = document.querySelector('form');

  form?.addEventListener('submit', async event => {
    event.preventDefault();

    const formData = new FormData(form);
    const { error } = await actions.auth.register(formData);

    if (!error) {
      // Redirect to home page on successful registration
      navigate('/');
    }
  });
</script>
