---
alwaysApply: true
---

# MyRandomCalendar - General Project Rules

## ğŸ¯ Project Overview
A calendar application built with Astro 5, featuring BetterAuth authentication with Google OAuth integration.

## ğŸ›  Tech Stack
- **Astro 5** - Web framework
- **TailwindCSS 4** - Styling
- **React 19** - UI components, pure and functional. Only manage presentational state, NO DATA FETCHING.
- **ShadCN UI** - Component library for consistent UI elements
- **ESLint 9** - Code linting
- **Astro DB** - Database with Drizzle ORM client (accessible from "astro:db")
- **libsql** - Database provider
- **BetterAuth** - Authentication system (replaces custom auth)
- **Date-FNS** - For handling dates and times. Always prefer using this.

## ğŸ” Authentication Status: WORKING
- **BetterAuth Migration**: Complete - all custom auth code removed
- **Google OAuth**: Fully functional and tested
- **Email/Password**: Available as alternative
- **Session Management**: Handled by BetterAuth automatically

## ğŸ—„ Database Schema (CRITICAL)
The database schema MUST match BetterAuth's exact field names:

```typescript
// CRITICAL: These field names are non-negotiable
const Accounts = defineTable({
  columns: {
    id: column.text({ primaryKey: true }),
    accountId: column.text({ unique: true }),
    userId: column.text({ references: () => Users.columns.id }),
    providerId: column.text(),                    // NOT "provider"
    providerAccountId: column.text({ optional: true }),
    accessToken: column.text({ optional: true }),
    refreshToken: column.text({ optional: true }),
    accessTokenExpiresAt: column.date({ optional: true }), // NOT "expiresAt"
    tokenType: column.text({ optional: true }),
    scope: column.text({ optional: true }),
    idToken: column.text({ optional: true }),
    sessionState: column.text({ optional: true }),
    createdAt: column.date(),
    updatedAt: column.date(),
  },
});
```

## ğŸ”§ Environment Variables (System Environment)
```bash
GOOGLE_CLIENT_ID=your-client-id-here
GOOGLE_CLIENT_SECRET=your-client-secret-here
BETTER_AUTH_SECRET=your-secret-key-here
```
**âš ï¸ IMPORTANT**: These are in system environment, NOT in `.env.local` files.

## ğŸ“ Key File Structure
```
src/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ better-auth.ts      # BetterAuth configuration (CRITICAL)
â”‚   â”œâ”€â”€ auth-client.ts      # Client-side auth utilities
â”‚   â””â”€â”€ types.ts           # Database type definitions
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ api/auth/[...all].ts # Catch-all BetterAuth API route
â”‚   â””â”€â”€ login.astro         # Login page with Google button
â”œâ”€â”€ actions/
â”‚   â”œâ”€â”€ login.ts            # Uses auth.api.signInEmail()
â”‚   â”œâ”€â”€ register.ts         # Uses auth.api.signUpEmail()
â”‚   â””â”€â”€ logout.ts           # Uses auth.api.signOut()
â””â”€â”€ middleware.ts           # Uses auth.api.getSession()
```

## ğŸš¨ Critical Configuration
```typescript
// src/lib/better-auth.ts - MUST have this exact configuration
export const auth = betterAuth({
  secret: process.env.BETTER_AUTH_SECRET as string,  // CRITICAL: Session encryption
  trustedOrigins: [                                  // CRITICAL: For local development
    "http://localhost:4321",
    "http://randomcalendar-dev.d13z.dev",
    "https://randomcalendar-dev.d13z.dev"
  ],
  database: drizzleAdapter(db, {
    provider: "sqlite",
    schema: {
      user: Users,
      session: Sessions,
      account: Accounts,      // Singular names
      verification: Verifications,
    },
    usePlural: false,        // CRITICAL: Must be false
  }),
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID as string,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET as string,
    },
  },
});
```

## ğŸ” Common Issues & Quick Fixes
- **Schema Errors**: Use `npm astro -- db push --force-reset` for breaking changes
- **Field Name Errors**: Check BetterAuth documentation for exact field names
- **OAuth Errors**: Verify Google Cloud Console redirect URI: `http://localhost:4321/api/auth/callback/google`
- **Environment Issues**: Check system environment variables, not .env files
- **Trusted Origins Error**: Add `trustedOrigins` array to BetterAuth config for local development

## ğŸ“š Documentation Location
- **`docs/README.md`** - Navigation guide
- **`docs/GOOGLE_OAUTH_SETUP.md`** - Overview and status
- **`docs/BETTERAUTH_DOCUMENTATION.md`** - Detailed technical reference

## âš¡ Quick Commands
```bash
npm run dev                    # Start development server
npm run astro -- db push --force-reset    # Reset database schema
npm test -- --run # Run tests without waiting for user input
npm run astro -- check # to check typescript errors in astro and ts files
printenv | grep GOOGLE         # Check Google credentials
```

## ğŸ¯ Current Status
- âœ… BetterAuth fully integrated
- âœ… Google OAuth working and tested
- âœ… Database schema aligned
- âœ… All authentication flows functional
- âœ… Server-side data fetching implemented
- âœ… **Background Events System** - Availability visualization with FullCalendar
- âœ… **Pure Function Architecture** - Comprehensive test coverage (91 tests)
- âœ… **ShadCN UI Integration** - Consistent button components across all pages
- âœ… Documentation complete

## ğŸ¨ UI Component Guidelines
- **ShadCN UI** is the primary component library for all UI elements
- **Button Components**: Use `Button` for buttons, `ButtonLink` for link buttons
- **Never use custom button styling** - only ShadCN variants
- **Variant Selection**: Choose variants semantically (default, secondary, destructive, outline, ghost, link)
- **Import Patterns**: Use `@/components/ui/button` in Astro, `./ui/button` in React
- **Styling**: Use `className` for React components, `class` for Astro/HTML elements
- See detailed rules in `rules-ui.mdc` and `rules-react.mdc`

## ğŸ— Feature Architecture Pattern (MANDATORY)

### **Feature Structure**
All new features MUST follow this exact structure in `src/features/{feature-name}/`:

```
src/features/
â”œâ”€â”€ {feature-name}/
â”‚   â”œâ”€â”€ actions/           # Astro actions (API endpoints)
â”‚   â”‚   â”œâ”€â”€ {actionName}.ts
â”‚   â”‚   â””â”€â”€ index.ts       # Exports all actions as named object
â”‚   â”œâ”€â”€ db/               # Database CRUD operations
â”‚   â”‚   â”œâ”€â”€ create.ts
â”‚   â”‚   â”œâ”€â”€ get.ts
â”‚   â”‚   â”œâ”€â”€ update.ts
â”‚   â”‚   â”œâ”€â”€ delete.ts
â”‚   â”‚   â””â”€â”€ [other-crud].ts
â”‚   â”œâ”€â”€ domain/           # Business logic (reserved for future use)
â”‚   â”œâ”€â”€ services/         # Page-specific business logic
â”‚   â”‚   â””â”€â”€ {page}-handler.ts
â”‚   â””â”€â”€ models/           # Data definitions
â”‚       â”œâ”€â”€ {FeatureName}.db.ts      # Astro DB table definition
â”‚       â”œâ”€â”€ {FeatureName}.schema.ts  # Zod validation schemas
â”‚       â””â”€â”€ {FeatureName}.types.ts   # TypeScript interfaces
```

### **File Naming Conventions**
- **Actions**: `camelCase.ts` (e.g., `createScheduleBlock.ts`)
- **DB**: `camelCase.ts` (e.g., `create.ts`, `get.ts`)
- **Models**: `PascalCase.{db|schema|types}.ts` (e.g., `ScheduleBlock.db.ts`)
- **Services**: `{page}-handler.ts` (e.g., `maintainer-handler.ts`)

### **Action Pattern**
```typescript
// actions/{actionName}.ts
export const {actionName} = defineAction({
  accept: 'form',
  input: {FeatureName}FormSchema,
  handler: async (data, context): Promise<{FeatureName}Type> => {
    try {
      // âœ… UPDATED: Use context.locals.user for better performance
      if (!context.locals.user) {
        throw new ActionError({ 
          code: 'UNAUTHORIZED',
          message: 'You must be logged in to {action description}'
        });
      }
      
      // Prepare data with userId
      const {featureName}Data: New{FeatureName} = {
        ...data,
        userId: context.locals.user.id,
      };
      
      // Call DB function
      const result = await {dbFunction}({featureName}Data);
      
      // Return result directly
      return result;
    } catch (error) {
      console.error('Error in {actionName}:', error);
      
      if (error instanceof ActionError) {
        throw error;
      }
      
      throw new ActionError({
        code: 'INTERNAL_SERVER_ERROR',
        message: 'Failed to {action description}',
      });
    }
  },
});
```

### **Services Pattern**
```typescript
// services/{page}-handler.ts
export interface {Page}PageData {
  // Structured data interface
  data1: Type1[];
  data2: Type2[];
  formOptions: FormOptions;
  successMessage?: string;
  errorMessage?: string;
}

export async function handle{Page}Page(
  context: ActionAPIContext,
  ...params
): Promise<{Page}PageData | null> {
  try {
    if (!context.locals.user) {
      return null;
    }

    // Pure business logic
    // Data fetching and transformation
    // No presentation concerns
    
    return {
      data1,
      data2,
      formOptions,
      successMessage,
      errorMessage
    };
  } catch (error) {
    console.error('Error in handle{Page}Page:', error);
    return null;
  }
}
```

### **DB Pattern**
```typescript
// db/{operation}.ts
export async function {operationName}(data: {Type}): Promise<{Type}> {
  // Pure database operations only
  // No business logic
  // Return properly typed data
}
```

### **Models Pattern**
- **`.db.ts`**: Astro DB table definitions with `defineTable`
- **`.schema.ts`**: Zod schemas for validation with proper error messages
- **`.types.ts`**: TypeScript interfaces and type definitions

### **Index Export Pattern**
```typescript
// actions/index.ts
import { action1 } from "./action1";
import { action2 } from "./action2";

const {featureName} = {
  action1,
  action2,
};

export default {featureName};
```

### **Examples**
- âœ… `src/features/schedule/` - Complete implementation
- âœ… `src/features/periodic-events/` - Complete implementation
- âŒ Any feature not following this exact structure

### **Domain Folder**
- Currently empty but reserved for business logic
- Will contain pure functions for complex business rules
- Separates business logic from data access and API layers

---
*Last Updated: January 15, 2025 - Added Feature Architecture Pattern*